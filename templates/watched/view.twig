{% extends 'base.twig' %}

{% block title %}{{ playlist.name }} - {{ app_name }}{% endblock %}

{% block content %}
<div class="tabs">
    <a href="/" class="tab">Search</a>
    <a href="/library" class="tab">Library</a>
    <a href="/queue" class="tab">Queue</a>
    <a href="/import" class="tab">Import</a>
    <a href="/watched" class="tab active">Watched</a>
    <a href="/settings" class="tab">Settings</a>
</div>

<div class="settings-section">
    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px;">
        <div>
            <a href="/watched" style="color: var(--text-secondary); text-decoration: none; font-size: 13px;">‚Üê Back to list</a>
            <h2 style="margin: 8px 0 4px 0;">{{ playlist.name }}</h2>
            <div style="display: flex; gap: 12px; flex-wrap: wrap; font-size: 13px; color: var(--text-secondary);">
                <span class="source-badge {{ playlist.platform }}">{{ playlist.platform|capitalize }}</span>
                <span>{{ playlist.sync_mode|capitalize }} mode</span>
                {% if playlist.make_m3u %}<span>üéµ M3U enabled</span>{% endif %}
                <span>Refresh: every {{ playlist.refresh_interval_hours }}h</span>
                <span>{{ playlist.enabled ? '‚úÖ Active' : '‚õî Paused' }}</span>
            </div>
        </div>
        <div style="display: flex; gap: 8px;">
            <button 
                class="btn"
                hx-post="/watched/{{ playlist.id }}/refresh"
                hx-target="#playlist-stats"
                hx-indicator="#action-spinner"
            >
                üîÑ Refresh Now
            </button>
            {% if playlist.pending_tracks > 0 %}
            <button 
                class="btn"
                hx-post="/watched/{{ playlist.id }}/queue"
                hx-target="#tracks-container"
                hx-indicator="#action-spinner"
            >
                ‚è¨ Queue Pending ({{ playlist.pending_tracks }})
            </button>
            {% endif %}
            {% if playlist.failed_tracks > 0 %}
            <button 
                class="btn"
                hx-post="/watched/{{ playlist.id }}/retry"
                hx-target="#tracks-container"
                hx-indicator="#action-spinner"
            >
                üîÅ Retry {{ playlist.failed_tracks }} Failed
            </button>
            {% endif %}
            {% if playlist.make_m3u and m3u_exists %}
            <button 
                class="btn"
                onclick="copyM3uLink()"
                title="Copy M3U link to clipboard"
            >
                üìã Copy M3U Link
            </button>
            <a 
                href="/music/Playlists/{{ m3u_filename|url_encode }}"
                download="{{ m3u_filename }}"
                class="btn btn-icon-only"
                title="Download M3U file"
            >
                ‚¨á
            </a>
            {% endif %}
            <span id="action-spinner" class="htmx-indicator">‚è≥</span>
        </div>
    </div>

    <div id="playlist-stats" style="display: flex; gap: 20px; padding: 12px; background: var(--card-bg); border-radius: 8px; margin-bottom: 16px;">
        <div style="text-align: center;">
            <div style="font-size: 24px; font-weight: bold;">{{ playlist.total_tracks|default(0) }}</div>
            <div style="font-size: 12px; color: var(--text-secondary);">Total</div>
        </div>
        <div style="text-align: center;">
            <div style="font-size: 24px; font-weight: bold; color: var(--success);">{{ playlist.downloaded_tracks|default(0) }}</div>
            <div style="font-size: 12px; color: var(--text-secondary);">Downloaded</div>
        </div>
        <div style="text-align: center;">
            <div style="font-size: 24px; font-weight: bold; color: var(--warning);">{{ playlist.queued_tracks|default(0) }}</div>
            <div style="font-size: 12px; color: var(--text-secondary);">Queued</div>
        </div>
        <div style="text-align: center;">
            <div style="font-size: 24px; font-weight: bold;">{{ playlist.pending_tracks|default(0) }}</div>
            <div style="font-size: 12px; color: var(--text-secondary);">Pending</div>
        </div>
        <div style="text-align: center;">
            <div style="font-size: 24px; font-weight: bold; color: var(--error);">{{ playlist.failed_tracks|default(0) }}</div>
            <div style="font-size: 12px; color: var(--text-secondary);">Failed</div>
        </div>
    </div>

    <div id="m3u-result"></div>

    <div id="auto-queue-status"></div>

    <div style="margin-bottom: 12px;">
        <span style="font-size: 13px; color: var(--text-secondary);">Filter: </span>
        <a href="/watched/{{ playlist.id }}" class="tab-link {{ not status_filter ? 'active' : '' }}">All</a>
        <a href="/watched/{{ playlist.id }}?status=downloaded" class="tab-link {{ status_filter == 'downloaded' ? 'active' : '' }}">Downloaded</a>
        <a href="/watched/{{ playlist.id }}?status=queued" class="tab-link {{ status_filter == 'queued' ? 'active' : '' }}">Queued</a>
        <a href="/watched/{{ playlist.id }}?status=pending" class="tab-link {{ status_filter == 'pending' ? 'active' : '' }}">Pending</a>
        <a href="/watched/{{ playlist.id }}?status=failed" class="tab-link {{ status_filter == 'failed' ? 'active' : '' }}">Failed</a>
    </div>

    <div id="tracks-container">
        {% include 'watched/_tracks_list.twig' %}
    </div>
    
    {% if pagination.total_pages > 1 %}
    <div style="display: flex; justify-content: center; gap: 8px; margin-top: 16px; flex-wrap: wrap;">
        {% if pagination.page > 1 %}
        <a href="/watched/{{ playlist.id }}?{% if status_filter %}status={{ status_filter }}&{% endif %}page={{ pagination.page - 1 }}" class="btn btn-small">‚Üê Prev</a>
        {% endif %}
        
        {% for p in range(1, pagination.total_pages) %}
            {% if p == pagination.page %}
            <span class="btn btn-small" style="background: var(--primary); color: white;">{{ p }}</span>
            {% elseif p == 1 or p == pagination.total_pages or (p >= pagination.page - 2 and p <= pagination.page + 2) %}
            <a href="/watched/{{ playlist.id }}?{% if status_filter %}status={{ status_filter }}&{% endif %}page={{ p }}" class="btn btn-small">{{ p }}</a>
            {% elseif p == pagination.page - 3 or p == pagination.page + 3 %}
            <span style="color: var(--text-muted);">...</span>
            {% endif %}
        {% endfor %}
        
        {% if pagination.page < pagination.total_pages %}
        <a href="/watched/{{ playlist.id }}?{% if status_filter %}status={{ status_filter }}&{% endif %}page={{ pagination.page + 1 }}" class="btn btn-small">Next ‚Üí</a>
        {% endif %}
    </div>
    <div style="text-align: center; margin-top: 8px; font-size: 12px; color: var(--text-muted);">
        Showing {{ ((pagination.page - 1) * pagination.per_page) + 1 }}-{{ pagination.page * pagination.per_page < pagination.total ? pagination.page * pagination.per_page : pagination.total }} of {{ pagination.total }} tracks
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<style>
.tab-link {
    display: inline-block;
    padding: 4px 10px;
    color: var(--text-secondary);
    text-decoration: none;
    border-radius: 4px;
    font-size: 12px;
}
.tab-link:hover {
    background: var(--card-bg);
}
.tab-link.active {
    background: var(--primary);
    color: white;
}
#auto-queue-status {
    padding: 10px 14px;
    background: var(--card-bg);
    border-radius: 6px;
    font-size: 13px;
    margin-bottom: 12px;
    display: none;
}
#auto-queue-status.active {
    display: block;
}
.btn-icon-only {
    width: 38px;
    padding: 0;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}
</style>

<script>
// Copy M3U link to clipboard
function copyM3uLink() {
    const m3uUrl = window.location.origin + '/music/Playlists/{{ m3u_filename|url_encode }}';
    navigator.clipboard.writeText(m3uUrl).then(() => {
        // Show toast notification
        const toast = document.createElement('div');
        toast.className = 'toast show';
        toast.textContent = 'M3U link copied!';
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 2000);
    }).catch(err => {
        console.error('Failed to copy:', err);
        // Fallback: show the URL in a prompt
        prompt('Copy this M3U link:', m3uUrl);
    });
}

(function() {
    const playlistId = '{{ playlist.id }}';
    let autoQueueActive = false;
    let pollInterval = null;
    
    // Status display element
    const statusEl = document.getElementById('auto-queue-status');
    
    function updateStatusDisplay(msg, isActive) {
        if (statusEl) {
            statusEl.textContent = msg;
            statusEl.classList.toggle('active', isActive);
        }
    }
    
    function updateStats(data) {
        // Update the stats display
        const statsEl = document.getElementById('playlist-stats');
        if (statsEl) {
            const divs = statsEl.querySelectorAll('div > div:first-child');
            if (divs.length >= 5) {
                divs[0].textContent = data.total;
                divs[1].textContent = data.downloaded;
                divs[2].textContent = data.queued;
                divs[3].textContent = data.pending;
                divs[4].textContent = data.failed;
            }
        }
    }
    
    async function checkAndQueueNext() {
        if (!autoQueueActive) return;
        
        try {
            // Get current status
            const statusRes = await fetch(`/watched/${playlistId}/status`);
            const status = await statusRes.json();
            
            updateStats(status);
            
            // If no queued tracks and there are pending tracks, queue next batch
            if (status.queued === 0 && status.pending > 0) {
                updateStatusDisplay(`‚è≥ Queueing next batch... (${status.pending} pending)`, true);
                
                const queueRes = await fetch(`/watched/${playlistId}/queue-batch`, { method: 'POST' });
                const queueData = await queueRes.json();
                
                if (queueData.queued > 0) {
                    updateStatusDisplay(`‚úÖ Queued ${queueData.queued} tracks. ${queueData.remaining_pending} pending, ${queueData.remaining_queued} in queue.`, true);
                } else if (queueData.remaining_pending === 0) {
                    // All done!
                    stopAutoQueue();
                    updateStatusDisplay('‚úÖ All tracks have been queued!', true);
                    setTimeout(() => updateStatusDisplay('', false), 3000);
                }
            } else if (status.queued > 0) {
                updateStatusDisplay(`üîÑ Processing... ${status.queued} in queue, ${status.pending} pending`, true);
            } else if (status.pending === 0) {
                // All done
                stopAutoQueue();
                updateStatusDisplay('‚úÖ All tracks processed!', true);
                setTimeout(() => updateStatusDisplay('', false), 3000);
            }
        } catch (err) {
            console.error('Auto-queue error:', err);
            updateStatusDisplay('‚ö†Ô∏è Error checking queue status', true);
        }
    }
    
    function startAutoQueue() {
        if (autoQueueActive) return;
        autoQueueActive = true;
        updateStatusDisplay('üöÄ Starting auto-queue...', true);
        checkAndQueueNext();
        pollInterval = setInterval(checkAndQueueNext, 5000); // Check every 5 seconds
    }
    
    function stopAutoQueue() {
        autoQueueActive = false;
        if (pollInterval) {
            clearInterval(pollInterval);
            pollInterval = null;
        }
    }
    
    // Expose for button click
    window.startAutoQueue = startAutoQueue;
    window.stopAutoQueue = stopAutoQueue;
    
    // Auto-start if there are pending tracks and user clicked "Queue Pending"
    document.body.addEventListener('htmx:afterRequest', function(evt) {
        if (evt.detail.pathInfo.requestPath.includes('/queue')) {
            // User triggered queueing, start auto-queue
            startAutoQueue();
        }
    });
})();
</script>
{% endblock %}
