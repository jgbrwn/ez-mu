{% extends 'base.twig' %}

{% block title %}Settings - {{ app_name }}{% endblock %}

{% block content %}
<div class="tabs">
    <a href="/" class="tab">Search</a>
    <a href="/library" class="tab">Library</a>
    <a href="/queue" class="tab">Queue</a>
    <a href="/import" class="tab">Import</a>
    <a href="/watched" class="tab">Watched</a>
    <a href="/settings" class="tab active">Settings</a>
</div>

<form hx-post="/settings" hx-target="#save-result" hx-swap="innerHTML">
    <div class="settings-section">
        <div class="settings-section-title">Search Sources</div>
        <div class="settings-grid">
            <div style="padding: 12px; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 12px;">
                <div style="font-size: 13px; color: var(--text-primary); margin-bottom: 8px;">
                    <strong>ðŸŽµ Monochrome/Tidal</strong> - Primary (Lossless FLAC)
                </div>
                <div style="font-size: 12px; color: var(--text-secondary);">
                    Always enabled. Provides genuine lossless audio directly from Tidal CDN.
                </div>
            </div>
            <div style="padding: 12px; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 12px;">
                <div style="font-size: 13px; color: var(--text-primary); margin-bottom: 8px;">
                    <strong>ðŸ”Š SoundCloud</strong> - Secondary
                </div>
                <div style="font-size: 12px; color: var(--text-secondary);">
                    Always enabled. Fills gaps for tracks not on Tidal.
                </div>
            </div>
            <label class="settings-label">
                <div>
                    <span>ðŸ“º YouTube</span>
                    <div style="font-size: 11px; color: var(--text-secondary);">Requires cookies for most videos</div>
                </div>
                <div class="toggle-switch">
                    <input type="checkbox" name="youtube_enabled" value="1" {% if settings.youtube_enabled == '1' %}checked{% endif %}>
                    <span class="toggle-slider"></span>
                </div>
            </label>
        </div>
    </div>

    <div class="settings-section" id="youtube-cookies-section" style="{% if settings.youtube_enabled != '1' %}opacity: 0.5;{% endif %}">
        <div class="settings-section-title">YouTube Cookies</div>
        <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 12px;">
            YouTube requires authentication for most videos. Export cookies from your browser using an extension like "Get cookies.txt LOCALLY".
        </div>
        <div class="settings-row">
            <label>Paste cookies.txt content:</label>
            <textarea name="youtube_cookies" rows="4" placeholder="# Netscape HTTP Cookie File..." style="font-family: monospace; font-size: 11px;">{{ settings.youtube_cookies_content|default('') }}</textarea>
        </div>
        {% if settings.youtube_cookies_path %}
        <div style="font-size: 11px; color: var(--accent); margin-top: 8px;">âœ“ Cookies configured</div>
        {% endif %}
    </div>

    <div class="settings-section">
        <div class="settings-section-title">Downloads</div>
        <div class="settings-grid">
            <label class="settings-label">
                <span>Organize by Artist</span>
                <div class="toggle-switch">
                    <input type="checkbox" name="organize_by_artist" value="1" {% if settings.organize_by_artist == '1' %}checked{% endif %}>
                    <span class="toggle-slider"></span>
                </div>
            </label>
            {% if environment.features['YouTube Downloads'] or environment.features['SoundCloud Downloads'] %}
            <label class="settings-label">
                <div>
                    <span>Convert to FLAC</span>
                    <div style="font-size: 11px; color: var(--text-secondary);">YouTube/SoundCloud only</div>
                </div>
                <div class="toggle-switch">
                    <input type="checkbox" name="convert_to_flac" value="1" {% if settings.convert_to_flac != '0' %}checked{% endif %}>
                    <span class="toggle-slider"></span>
                </div>
            </label>
            {% endif %}
        </div>
        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 8px; padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
            Monochrome/Tidal downloads are always lossless FLAC (16-bit/44.1kHz).
            {% if environment.features['YouTube Downloads'] or environment.features['SoundCloud Downloads'] %}
            <br>YouTube/SoundCloud downloads {{ settings.convert_to_flac != '0' ? 'will be converted to FLAC' : 'keep original format' }}.
            {% endif %}
        </div>
    </div>

    <div class="settings-section">
        <div class="settings-section-title">Metadata</div>
        <div class="settings-grid">
            <label class="settings-label">
                <div>
                    <span>MusicBrainz Lookup</span>
                    <div style="font-size: 11px; color: var(--text-secondary);">Fingerprint audio + enrich metadata</div>
                </div>
                <div class="toggle-switch">
                    <input type="checkbox" name="enable_musicbrainz" value="1" {% if settings.enable_musicbrainz != '0' %}checked{% endif %}>
                    <span class="toggle-slider"></span>
                </div>
            </label>
        </div>
        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 8px; padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
            When enabled, downloads are fingerprinted with AcoustID and matched against MusicBrainz to get accurate artist, title, album, and year metadata. For Monochrome/Tidal sources, only the release year is enriched (Tidal metadata is authoritative).
        </div>
    </div>

    <div class="settings-section">
        <div class="settings-section-title">Playback</div>
        <div class="settings-grid">
            <label class="settings-label">
                <div>
                    <span>Auto-play Next Track</span>
                    <div style="font-size: 11px; color: var(--text-secondary);">In Library, play next track when current ends</div>
                </div>
                <div class="toggle-switch">
                    <input type="checkbox" name="autoplay_next" value="1" {% if settings.autoplay_next == '1' %}checked{% endif %}>
                    <span class="toggle-slider"></span>
                </div>
            </label>
        </div>
    </div>

    <div class="settings-section">
        <div class="settings-section-title">Appearance</div>
        <div class="settings-grid">
            <label class="settings-label">
                <span>Theme</span>
                <select name="theme" style="padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                    <option value="dark" {% if settings.theme == 'dark' %}selected{% endif %}>Dark</option>
                    <option value="light" {% if settings.theme == 'light' %}selected{% endif %}>Light</option>
                </select>
            </label>
        </div>
    </div>

    <div class="settings-actions">
        <button type="submit" class="save-btn">Save Settings</button>
        <div id="save-result" class="save-result"></div>
    </div>
</form>

<div class="settings-section" style="margin-top: 24px;">
    <div class="settings-section-title">Library Maintenance</div>
    <div style="padding: 12px; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 16px;">
        <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px;">
            Check for orphaned database entries and missing files. This can happen if files are manually deleted or moved.
        </p>
        <div id="validation-container">
            <button hx-post="/settings/validate-library"
                    hx-target="#validation-container"
                    hx-swap="innerHTML"
                    class="btn"
                    style="background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border); padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                Validate Library
            </button>
        </div>
    </div>
</div>

<div class="settings-section" style="margin-top: 24px;">
    <div class="settings-section-title">System Information</div>
    <div style="padding: 12px; background: var(--bg-tertiary); border-radius: 8px;">
        <div style="margin-bottom: 12px;">
            <strong style="color: var(--accent);">{{ environment.mode }}</strong>
        </div>
        
        <div style="font-size: 13px; margin-bottom: 12px;">
            <strong>Search Sources:</strong>
            <ul style="margin: 8px 0; padding-left: 20px; color: var(--text-secondary);">
                {% for source, status in environment.search_sources %}
                <li>{{ source|capitalize }}: 
                    {% if status == 'Available' %}
                    <span style="color: var(--accent);">âœ“ {{ status }}</span>
                    {% else %}
                    <span style="color: var(--text-secondary);">âœ— {{ status }}</span>
                    {% endif %}
                </li>
                {% endfor %}
            </ul>
        </div>
        
        <div style="font-size: 13px; margin-bottom: 12px;">
            <strong>Features:</strong>
            <ul style="margin: 8px 0; padding-left: 20px; color: var(--text-secondary);">
                {% for feature, available in environment.features %}
                <li>{{ feature }}: 
                    {% if available %}
                    <span style="color: var(--accent);">âœ“</span>
                    {% else %}
                    <span style="color: var(--error);">âœ—</span>
                    {% endif %}
                </li>
                {% endfor %}
            </ul>
        </div>
        
        <details style="font-size: 12px; color: var(--text-secondary);">
            <summary style="cursor: pointer; margin-bottom: 8px;">Binary Paths (Advanced)</summary>
            <ul style="margin: 8px 0; padding-left: 20px; font-family: monospace; font-size: 11px;">
                {% for binary, path in environment.binaries %}
                <li>{{ binary }}: {{ path }}</li>
                {% endfor %}
            </ul>
        </details>
    </div>
</div>

<script>
// Toggle YouTube cookies section visibility
document.querySelector('input[name="youtube_enabled"]').addEventListener('change', function() {
    document.getElementById('youtube-cookies-section').style.opacity = this.checked ? '1' : '0.5';
});
</script>
{% endblock %}
