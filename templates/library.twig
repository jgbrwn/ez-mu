{% extends 'base.twig' %}

{% block title %}Library - {{ app_name }}{% endblock %}

{% block content %}
<div class="tabs">
    <a href="/" class="tab">Search</a>
    <a href="/library" class="tab active">Library <span style="opacity: 0.6;">({{ stats.track_count }})</span></a>
    <a href="/queue" class="tab">Queue</a>
    <a href="/import" class="tab">Import</a>
    <a href="/settings" class="tab">Settings</a>
</div>

<div class="search-box" style="margin-bottom: 16px;">
    <form hx-get="/partials/library" hx-target="#library-list" hx-trigger="input changed delay:300ms from:#librarySearch, submit">
        <input
            type="text"
            class="search-input"
            id="librarySearch"
            name="q"
            placeholder="Search your library..."
            value="{{ query }}"
            autocomplete="off"
            style="padding-right: 20px;"
        >
    </form>
</div>

<div class="queue-header">
    <h2 style="font-size: 14px; font-weight: 600; color: var(--text-secondary);">
        {{ stats.track_count }} tracks ‚Ä¢ {{ (stats.total_size / 1048576)|number_format(1) }} MB
    </h2>
    <div style="display: flex; gap: 8px;">
        <button id="selectAllBtn" class="clear-btn" style="color: var(--accent); border-color: var(--accent);" onclick="toggleSelectAll()">
            Select All
        </button>
        <form id="downloadForm" action="/library/download" method="POST">
            <button type="submit" class="clear-btn" style="color: var(--accent); border-color: var(--accent);" id="downloadSelectedBtn" disabled>
                ‚¨á Download Selected
            </button>
        </form>
    </div>
</div>

<!-- Audio Player -->
<div id="player" class="player-container" style="display: none;">
    <div class="player-info">
        <img id="playerThumb" class="player-thumb" src="" alt="">
        <div class="player-meta">
            <div id="playerTitle" class="player-title">-</div>
            <div id="playerArtist" class="player-artist">-</div>
        </div>
    </div>
    <audio id="audioPlayer" controls style="width: 100%;"></audio>
</div>

<div id="library-list" class="results">
    {% include 'partials/library_list.twig' %}
</div>
{% endblock %}

{% block scripts %}
<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div style="font-size: 24px; margin-bottom: 12px;">üóëÔ∏è</div>
        <div style="font-size: 15px; font-weight: 600; margin-bottom: 8px;">Delete Track?</div>
        <div id="deleteModalTitle" style="font-size: 13px; color: var(--text-secondary); margin-bottom: 16px;"></div>
        <div style="display: flex; gap: 8px; justify-content: center;">
            <button onclick="closeDeleteModal()" class="clear-btn" style="padding: 8px 20px;">Cancel</button>
            <button onclick="executeDelete()" class="save-btn" style="padding: 8px 20px; background: var(--error);">Delete</button>
        </div>
    </div>
</div>
<style>
.player-container {
    position: sticky;
    bottom: 0;
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 12px 12px 0 0;
    padding: 12px;
    margin-top: 16px;
    z-index: 100;
}

.player-info {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
}

.player-thumb {
    width: 48px;
    height: 48px;
    border-radius: 6px;
    object-fit: cover;
    background: var(--bg-tertiary);
}

.player-meta {
    flex: 1;
    min-width: 0;
}

.player-title {
    font-size: 14px;
    font-weight: 600;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.player-artist {
    font-size: 12px;
    color: var(--text-secondary);
}

.track-item {
    display: flex;
    align-items: center;
    gap: 12px;
}

.track-checkbox {
    width: 18px;
    height: 18px;
    cursor: pointer;
    accent-color: var(--accent);
}

.track-play-btn {
    background: var(--accent);
    border: none;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    flex-shrink: 0;
}

.track-play-btn:hover {
    opacity: 0.9;
}

.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.modal-content {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 24px;
    text-align: center;
    max-width: 320px;
    width: 90%;
}

.delete-btn:hover {
    background: rgba(239, 68, 68, 0.2) !important;
    border-color: var(--error) !important;
    color: var(--error) !important;
}
</style>

<script>
const audioPlayer = document.getElementById('audioPlayer');
const playerContainer = document.getElementById('player');
let currentTrackId = null;

function playTrack(id, title, artist, thumbnail) {
    currentTrackId = id;
    audioPlayer.src = '/stream/' + id;
    document.getElementById('playerTitle').textContent = title;
    document.getElementById('playerArtist').textContent = artist;
    document.getElementById('playerThumb').src = thumbnail || '/static/placeholder.png';
    playerContainer.style.display = 'block';
    audioPlayer.play();
    
    // Update play buttons
    document.querySelectorAll('.track-play-btn').forEach(btn => {
        btn.textContent = btn.dataset.id === id ? '‚è∏' : '‚ñ∂';
    });
}

audioPlayer.addEventListener('ended', function() {
    // Could implement playlist functionality here
});

function toggleSelectAll() {
    const checkboxes = document.querySelectorAll('.track-checkbox');
    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
    checkboxes.forEach(cb => cb.checked = !allChecked);
    updateDownloadButton();
}

function updateDownloadButton() {
    const checked = document.querySelectorAll('.track-checkbox:checked');
    const btn = document.getElementById('downloadSelectedBtn');
    btn.disabled = checked.length === 0;
    btn.textContent = checked.length > 0 
        ? `‚¨á Download (${checked.length})`
        : '‚¨á Download Selected';
    
    // Update form with selected IDs
    const form = document.getElementById('downloadForm');
    form.querySelectorAll('input[name="tracks[]"]').forEach(el => el.remove());
    checked.forEach(cb => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'tracks[]';
        input.value = cb.value;
        form.appendChild(input);
    });
}

document.addEventListener('change', function(e) {
    if (e.target.classList.contains('track-checkbox')) {
        updateDownloadButton();
    }
});

// Delete confirmation
let deleteTarget = null;
let deleteTrackId = null;

function confirmDelete(btn) {
    deleteTarget = btn.closest('.result-item');
    deleteTrackId = btn.dataset.trackId;
    const title = btn.dataset.trackTitle;
    document.getElementById('deleteModalTitle').textContent = `"${title}" will be permanently removed from your library.`;
    document.getElementById('deleteModal').style.display = 'flex';
}

function closeDeleteModal() {
    document.getElementById('deleteModal').style.display = 'none';
    deleteTarget = null;
    deleteTrackId = null;
}

function executeDelete() {
    if (!deleteTrackId || !deleteTarget) return;
    
    fetch('/library/' + deleteTrackId, { method: 'DELETE' })
        .then(response => {
            if (response.ok) {
                // Animate removal
                deleteTarget.style.transition = 'opacity 0.3s, max-height 0.3s, margin 0.3s, padding 0.3s';
                deleteTarget.style.opacity = '0';
                deleteTarget.style.maxHeight = '0';
                deleteTarget.style.margin = '0';
                deleteTarget.style.padding = '0';
                deleteTarget.style.overflow = 'hidden';
                setTimeout(() => deleteTarget.remove(), 300);
                
                // Update track count in header
                const countEl = document.querySelector('.queue-header h2');
                if (countEl) {
                    const match = countEl.textContent.match(/(\d+) tracks/);
                    if (match) {
                        const newCount = parseInt(match[1]) - 1;
                        countEl.textContent = countEl.textContent.replace(/\d+ tracks/, newCount + ' tracks');
                    }
                }
            } else {
                alert('Failed to delete track');
            }
        })
        .catch(() => alert('Failed to delete track'))
        .finally(() => closeDeleteModal());
}

// Close modal on escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') closeDeleteModal();
});

// Close modal on overlay click
document.getElementById('deleteModal')?.addEventListener('click', function(e) {
    if (e.target === this) closeDeleteModal();
});
</script>
{% endblock %}
