{% extends 'base.twig' %}

{% block title %}Library - {{ app_name }}{% endblock %}

{% block content %}
<div class="tabs">
    <a href="/" class="tab">Search</a>
    <a href="/library" class="tab active">Library <span style="opacity: 0.6;">({{ library_stats.track_count }})</span></a>
    <a href="/queue" class="tab">Queue <span style="opacity: 0.6;">({{ queue_stats.queued + queue_stats.processing }})</span></a>
    <a href="/import" class="tab">Import</a>
    <a href="/watched" class="tab">Watched</a>
    <a href="/settings" class="tab">Settings</a>
</div>

<div class="search-box" style="margin-bottom: 16px;">
    <form id="libraryFilterForm" hx-get="/partials/library" hx-target="#library-list" hx-trigger="input changed delay:300ms from:#librarySearch, change from:#librarySort, submit">
        <div style="display: flex; gap: 12px; align-items: center;">
            <input
                type="text"
                class="search-input"
                id="librarySearch"
                name="q"
                placeholder="Search your library..."
                value="{{ query }}"
                autocomplete="off"
                style="flex: 1;"
            >
            <select name="sort" id="librarySort" style="padding: 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 14px; cursor: pointer;">
                <option value="recent" {{ sort == 'recent' ? 'selected' : '' }}>üïí Recently Added</option>
                <option value="artist" {{ sort == 'artist' ? 'selected' : '' }}>üé§ Artist A-Z</option>
                <option value="title" {{ sort == 'title' ? 'selected' : '' }}>üéµ Title A-Z</option>
            </select>
            <input type="hidden" name="page" value="1">
        </div>
    </form>
</div>

<div class="queue-header">
    <h2 class="library-stats" id="libraryStatsHeader" style="font-size: 14px; font-weight: 600; color: var(--text-secondary);">
        {{ totalTracks }} tracks ‚Ä¢ {{ (stats.total_size / 1048576)|number_format(1) }} MB
    </h2>
    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
        <button id="selectAllBtn" class="clear-btn" style="color: var(--accent); border-color: var(--accent);" onclick="toggleSelectAll()">
            Select All
        </button>
        <button type="button" class="clear-btn" style="color: var(--error); border-color: var(--error);" id="deleteSelectedBtn" disabled onclick="confirmBulkDelete()">
            üóë Delete Selected
        </button>
        <form id="downloadForm" action="/library/download" method="POST">
            <button type="submit" class="clear-btn" style="color: var(--accent); border-color: var(--accent);" id="downloadSelectedBtn" disabled>
                ‚¨á Download Selected
            </button>
        </form>
        {% if totalTracks > 0 %}
        <button type="button" class="clear-btn" style="color: var(--error); border-color: var(--error);" onclick="confirmDeleteAll()">
            üóë Delete All
        </button>
        {% endif %}
    </div>
</div>

<div id="library-list" class="results">
    {% include 'partials/library_list.twig' %}
</div>

<!-- Audio Player (fixed to bottom) -->
<div id="player" class="player-container" style="display: none;">
    <div class="player-info">
        <img id="playerThumb" class="player-thumb" src="" alt="">
        <div class="player-meta">
            <div id="playerTitle" class="player-title">-</div>
            <div id="playerArtist" class="player-artist">-</div>
        </div>
    </div>
    <audio id="audioPlayer" controls style="width: 100%;"></audio>
</div>
{% endblock %}

{% block scripts %}
<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div style="font-size: 24px; margin-bottom: 12px;">üóëÔ∏è</div>
        <div id="deleteModalHeading" style="font-size: 15px; font-weight: 600; margin-bottom: 8px;">Delete Track?</div>
        <div id="deleteModalTitle" style="font-size: 13px; color: var(--text-secondary); margin-bottom: 16px;"></div>
        <div style="display: flex; gap: 8px; justify-content: center;">
            <button onclick="closeDeleteModal()" class="clear-btn" style="padding: 8px 20px;">Cancel</button>
            <button id="deleteModalBtn" onclick="executeDelete()" class="save-btn" style="padding: 8px 20px; background: var(--error);">Delete</button>
        </div>
    </div>
</div>
<style>
.player-container {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: var(--bg-secondary);
    border-top: 1px solid var(--border);
    padding: 12px;
    padding-bottom: max(12px, env(safe-area-inset-bottom));
    z-index: 100;
    max-width: 900px;
    margin: 0 auto;
}

/* Add padding to library list so pagination isn't hidden behind player */
#library-list {
    padding-bottom: 140px;
}

.player-info {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
}

.player-thumb {
    width: 48px;
    height: 48px;
    border-radius: 6px;
    object-fit: cover;
    background: var(--bg-tertiary);
}

.player-meta {
    flex: 1;
    min-width: 0;
}

.player-title {
    font-size: 14px;
    font-weight: 600;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.player-artist {
    font-size: 12px;
    color: var(--text-secondary);
}

.track-item {
    display: flex;
    align-items: center;
    gap: 12px;
}

.track-checkbox {
    width: 18px;
    height: 18px;
    cursor: pointer;
    accent-color: var(--accent);
}

.track-play-btn {
    background: var(--accent);
    border: none;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    flex-shrink: 0;
}

.track-play-btn:hover {
    opacity: 0.9;
}

.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.modal-content {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 24px;
    text-align: center;
    max-width: 320px;
    width: 90%;
}

.delete-btn:hover {
    background: rgba(239, 68, 68, 0.2) !important;
    border-color: var(--error) !important;
    color: var(--error) !important;
}
</style>

<script>
const audioPlayer = document.getElementById('audioPlayer');
const playerContainer = document.getElementById('player');
let currentTrackId = null;
const autoplayNext = {{ autoplayNext ? 'true' : 'false' }};

function playTrack(id, title, artist, thumbnail) {
    // Stop any currently playing track first
    if (!audioPlayer.paused) {
        audioPlayer.pause();
    }
    
    currentTrackId = id;
    audioPlayer.src = '/stream/' + id;
    document.getElementById('playerTitle').textContent = title;
    document.getElementById('playerArtist').textContent = artist;
    document.getElementById('playerThumb').src = thumbnail || '/static/placeholder.png';
    playerContainer.style.display = 'block';
    audioPlayer.play();
    
    // Update play buttons
    document.querySelectorAll('.track-play-btn').forEach(btn => {
        btn.textContent = btn.dataset.id === id ? '‚è∏' : '‚ñ∂';
    });
}

function playNextTrack() {
    if (!currentTrackId) return;
    
    // Get all track buttons in current order
    const buttons = Array.from(document.querySelectorAll('.track-play-btn'));
    const currentIndex = buttons.findIndex(btn => btn.dataset.id === currentTrackId);
    
    if (currentIndex >= 0 && currentIndex < buttons.length - 1) {
        // Play next track
        const nextBtn = buttons[currentIndex + 1];
        nextBtn.click();
    } else {
        // Reset play button state at end of list
        document.querySelectorAll('.track-play-btn').forEach(btn => {
            btn.textContent = '‚ñ∂';
        });
    }
}

audioPlayer.addEventListener('ended', function() {
    if (autoplayNext) {
        playNextTrack();
    } else {
        // Reset play button state
        document.querySelectorAll('.track-play-btn').forEach(btn => {
            btn.textContent = '‚ñ∂';
        });
    }
});

function toggleSelectAll() {
    const checkboxes = document.querySelectorAll('.track-checkbox');
    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
    checkboxes.forEach(cb => cb.checked = !allChecked);
    updateSelectAllButton();
    updateDownloadButton();
}

function updateSelectAllButton() {
    const checkboxes = document.querySelectorAll('.track-checkbox');
    const allChecked = checkboxes.length > 0 && Array.from(checkboxes).every(cb => cb.checked);
    const selectAllBtn = document.getElementById('selectAllBtn');
    selectAllBtn.textContent = allChecked ? 'Deselect All' : 'Select All';
}

function updateDownloadButton() {
    const checked = document.querySelectorAll('.track-checkbox:checked');
    const downloadBtn = document.getElementById('downloadSelectedBtn');
    const deleteBtn = document.getElementById('deleteSelectedBtn');
    
    downloadBtn.disabled = checked.length === 0;
    deleteBtn.disabled = checked.length === 0;
    
    downloadBtn.textContent = checked.length > 0 
        ? `‚¨á Download (${checked.length})`
        : '‚¨á Download Selected';
    
    deleteBtn.textContent = checked.length > 0 
        ? `üóë Delete (${checked.length})`
        : 'üóë Delete Selected';
    
    // Update form with selected IDs
    const form = document.getElementById('downloadForm');
    form.querySelectorAll('input[name="tracks[]"]').forEach(el => el.remove());
    checked.forEach(cb => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'tracks[]';
        input.value = cb.value;
        form.appendChild(input);
    });
}

document.addEventListener('change', function(e) {
    if (e.target.classList.contains('track-checkbox')) {
        updateDownloadButton();
        updateSelectAllButton();
    }
});

// Delete confirmation
let deleteTargets = [];  // Array for bulk delete
let deleteTrackIds = []; // Array for bulk delete
let isBulkDelete = false;

function confirmDelete(btn) {
    isBulkDelete = false;
    deleteTargets = [btn.closest('.result-item')];
    deleteTrackIds = [btn.dataset.trackId];
    const title = btn.dataset.trackTitle;
    
    document.getElementById('deleteModalHeading').textContent = 'Delete Track?';
    document.getElementById('deleteModalTitle').textContent = `"${title}" will be permanently removed from your library.`;
    document.getElementById('deleteModalBtn').textContent = 'Delete';
    document.getElementById('deleteModal').style.display = 'flex';
}

function confirmBulkDelete() {
    const checked = document.querySelectorAll('.track-checkbox:checked');
    if (checked.length === 0) return;
    
    isBulkDelete = true;
    deleteTargets = [];
    deleteTrackIds = [];
    
    checked.forEach(cb => {
        deleteTargets.push(cb.closest('.result-item'));
        deleteTrackIds.push(cb.value);
    });
    
    const count = deleteTrackIds.length;
    document.getElementById('deleteModalHeading').textContent = `Delete ${count} Track${count > 1 ? 's' : ''}?`;
    document.getElementById('deleteModalTitle').textContent = `${count} track${count > 1 ? 's' : ''} will be permanently removed from your library. This cannot be undone.`;
    document.getElementById('deleteModalBtn').textContent = `Delete ${count} Track${count > 1 ? 's' : ''}`;
    document.getElementById('deleteModal').style.display = 'flex';
}

function closeDeleteModal() {
    document.getElementById('deleteModal').style.display = 'none';
    deleteTargets = [];
    deleteTrackIds = [];
    isBulkDelete = false;
    isDeleteAll = false;
}

function refreshLibraryList() {
    // Get current filter/sort state
    const query = document.getElementById('librarySearch')?.value || '';
    const sort = document.getElementById('librarySort')?.value || 'recent';
    
    // Refresh the library list via HTMX - let server determine correct page
    htmx.ajax('GET', `/partials/library?q=${encodeURIComponent(query)}&sort=${sort}&page=1`, {
        target: '#library-list',
        swap: 'innerHTML'
    });
}

function executeDelete() {
    const deleteBtn = document.getElementById('deleteModalBtn');
    deleteBtn.disabled = true;
    deleteBtn.textContent = 'Deleting...';
    
    if (isDeleteAll) {
        // Delete entire library
        fetch('/library', { method: 'DELETE' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Reload the page to reset everything
                    window.location.reload();
                } else {
                    alert('Failed to delete library');
                }
            })
            .catch(() => alert('Failed to delete library'))
            .finally(() => {
                closeDeleteModal();
                deleteBtn.disabled = false;
            });
        return;
    }
    
    if (deleteTrackIds.length === 0) return;
    
    // Delete selected tracks
    const deletePromises = deleteTrackIds.map(id => 
        fetch('/library/' + id, { method: 'DELETE' })
    );
    
    Promise.all(deletePromises)
        .then(responses => {
            const successCount = responses.filter(r => r.ok).length;
            
            if (successCount < deleteTrackIds.length) {
                alert(`Deleted ${successCount} of ${deleteTrackIds.length} tracks. Some deletions failed.`);
            }
            
            // Refresh library list to fix pagination
            refreshLibraryList();
            
            // Reset buttons
            updateDownloadButton();
            updateSelectAllButton();
        })
        .catch(() => alert('Failed to delete tracks'))
        .finally(() => {
            closeDeleteModal();
            deleteBtn.disabled = false;
        });
}

let isDeleteAll = false;

function confirmDeleteAll() {
    isDeleteAll = true;
    deleteTargets = [];
    deleteTrackIds = [];
    
    const countEl = document.getElementById('libraryStatsHeader');
    const match = countEl?.textContent.match(/(\d+) tracks/);
    const count = match ? parseInt(match[1]) : 'all';
    
    document.getElementById('deleteModalHeading').textContent = `Delete Entire Library?`;
    document.getElementById('deleteModalTitle').innerHTML = `<strong>${count}</strong> tracks will be permanently deleted.<br><span style="color: var(--error);">This cannot be undone!</span>`;
    document.getElementById('deleteModalBtn').textContent = 'Delete All';
    document.getElementById('deleteModal').style.display = 'flex';
}

// Close modal on escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') closeDeleteModal();
});

// Close modal on overlay click
document.getElementById('deleteModal')?.addEventListener('click', function(e) {
    if (e.target === this) closeDeleteModal();
});

// Reset select all button after HTMX refresh
document.body.addEventListener('htmx:afterSwap', function(e) {
    if (e.detail.target.id === 'library-list') {
        document.getElementById('selectAllBtn').textContent = 'Select All';
        updateDownloadButton();
    }
});
</script>
{% endblock %}
