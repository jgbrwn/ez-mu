{# OOB swap to update header stats (only for HTMX requests, not initial page load) #}
{% if stats is defined and (is_htmx is not defined or is_htmx) %}
<h2 id="libraryStatsHeader" hx-swap-oob="true" class="library-stats" style="font-size: 14px; font-weight: 600; color: var(--text-secondary);">
    {{ totalTracks }} tracks • {{ (stats.total_size / 1048576)|number_format(1) }} MB
</h2>
{% endif %}

{% if tracks is empty %}
<div class="empty-state">
    <div class="empty-state-icon"><span class="icon icon-music" style="width:48px;height:48px;opacity:0.3;"></span></div>
    <p>{% if query %}No tracks match "{{ query }}"{% else %}Your library is empty{% endif %}</p>
    <p style="font-size: 13px; margin-top: 8px;">{% if query %}Try a different search{% else %}Search and download music to build your collection{% endif %}</p>
</div>
{% else %}
{% for track in tracks %}
<div class="result-item track-item{% if track.file_missing %} file-missing{% endif %}" {% if track.file_missing %}style="opacity: 0.6; border-color: var(--error);"{% endif %}>
    <input type="checkbox" class="track-checkbox" name="tracks[]" value="{{ track.id }}" {% if track.file_missing %}disabled title="File missing from disk"{% endif %}>
    {% if track.file_missing %}
    <button type="button" class="track-play-btn" disabled style="cursor: not-allowed; opacity: 0.5;" title="File missing from disk">
        <span class="icon icon-warning" style="width:16px;height:16px;"></span>
    </button>
    {% else %}
    <button type="button" class="track-play-btn" data-id="{{ track.id }}" onclick="playTrack('{{ track.id }}', '{{ track.title|e('js') }}', '{{ track.artist|e('js') }}', '{{ track.thumbnail|e('js') }}')">
        ▶
    </button>
    {% endif %}
    {% if track.thumbnail %}
    <img class="result-thumb" src="{{ track.thumbnail }}" alt="" loading="lazy" style="width: 48px; height: 48px;" onerror="this.style.display='none';this.nextElementSibling.style.display='flex';">
    <div class="result-thumb music-note-placeholder small" style="display:none;width:48px;height:48px;"><span class="icon icon-music"></span></div>
    {% else %}
    <div class="result-thumb music-note-placeholder small" style="width:48px;height:48px;"><span class="icon icon-music"></span></div>
    {% endif %}
    <div class="result-info" style="flex: 1;">
        <div class="result-title">{{ track.title }}</div>
        <div class="result-meta">
            {{ track.artist }}
            {% if track.duration %}
            • {{ (track.duration / 60)|number_format(0) }}:{{ '%02d'|format(track.duration % 60) }}
            {% endif %}
        </div>
        <div class="result-badges">
            {% if track.file_missing %}
            <span class="source-badge" style="background: var(--error); color: #fff;">FILE MISSING</span>
            {% else %}
            {% if track.source %}
            <span class="source-badge {{ track.source }}">{{ track.source|upper }}</span>
            {% endif %}
            <span class="source-badge" style="background: var(--bg-tertiary); color: var(--text-secondary);">{{ track.codec|upper }}</span>
            {% if track.bitrate %}
            <span style="font-size: 11px; color: var(--text-secondary);">{{ track.bitrate }} kbps</span>
            {% endif %}
            {% endif %}
        </div>
    </div>
    <button 
        type="button"
        class="delete-btn clear-btn" 
        style="padding: 6px 12px; font-size: 12px;"
        data-track-id="{{ track.id }}"
        data-track-title="{{ track.title|e('html_attr') }}"
        onclick="confirmDelete(this)"
    >
        <span class="icon icon-trash" style="width:16px;height:16px;"></span>
    </button>
</div>
{% endfor %}

{# Pagination #}
{% if totalPages is defined and totalPages > 1 %}
<div class="pagination" style="margin-top: 16px;">
    {% if page > 1 %}
    <button 
        class="page-btn" 
        hx-get="/partials/library?page={{ page - 1 }}&sort={{ sort }}&q={{ query|url_encode }}"
        hx-target="#library-list"
        hx-swap="innerHTML"
    >
        ← Prev
    </button>
    {% endif %}
    
    <span style="color: var(--text-secondary); font-size: 13px;">
        Page {{ page }} of {{ totalPages }}
    </span>
    
    {% if page < totalPages %}
    <button 
        class="page-btn" 
        hx-get="/partials/library?page={{ page + 1 }}&sort={{ sort }}&q={{ query|url_encode }}"
        hx-target="#library-list"
        hx-swap="innerHTML"
    >
        Next →
    </button>
    {% endif %}
</div>
{% endif %}
{% endif %}
