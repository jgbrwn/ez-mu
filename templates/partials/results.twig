{% if error %}
<div class="empty-state">
    <div class="empty-state-icon">‚ö†Ô∏è</div>
    <p style="color: var(--error);">{{ error }}</p>
</div>
{% elseif results is empty %}
<div class="empty-state">
    <div class="empty-state-icon">{% if message and (message starts with 'Monochrome:' or 'error' in message|lower) %}‚ö†Ô∏è{% else %}üîç{% endif %}</div>
    <p{% if message and (message starts with 'Monochrome:' or 'error' in message|lower) %} style="color: var(--warning, #ffc107);"{% endif %}>{{ message|default('No results found') }}</p>
</div>
{% else %}
{% if warnings %}
<div class="search-warning" style="background: var(--warning-bg, rgba(255, 193, 7, 0.1)); border: 1px solid var(--warning, #ffc107); border-radius: 8px; padding: 12px 16px; margin-bottom: 16px; display: flex; align-items: center; gap: 10px;">
    <span style="font-size: 18px;">‚ö†Ô∏è</span>
    <span style="color: var(--warning, #ffc107);">{{ warnings|join('; ') }}</span>
</div>
{% endif %}
{% for result in results %}
{% if result.in_library %}
{# Already in library - show checkmark #}
<div class="result-item in-library">
    {% if result.thumbnail %}
    <img class="result-thumb" src="{{ result.thumbnail }}" alt="" loading="lazy" onerror="this.style.display='none';this.nextElementSibling.style.display='flex';">
    <div class="result-thumb music-note-placeholder" style="display:none;"><span class="icon icon-music"></span></div>
    {% else %}
    <div class="result-thumb music-note-placeholder"><span class="icon icon-music"></span></div>
    {% endif %}
    
    <div class="result-info">
        <div class="result-title">{{ result.title }}</div>
        <div class="result-meta">{{ result.artist }}</div>
        <div class="result-badges">
            <span class="source-badge {{ result.source }}">{{ result.source|upper }}</span>
            {% if result.quality %}
            <span class="quality-badge {% if result.quality == 'HI_RES_LOSSLESS' %}hires{% elseif result.quality == 'LOSSLESS' %}flac{% endif %}">{{ result.quality == 'HI_RES_LOSSLESS' ? 'Hi-Res' : (result.quality == 'LOSSLESS' ? 'Lossless' : result.quality) }}</span>
            {% endif %}
            <span class="result-duration">{{ result.duration_string }}</span>
        </div>
    </div>
    <div class="status-icon completed" title="In Library">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>
    </div>
</div>
{% elseif result.in_queue %}
{# Currently in queue - show processing indicator #}
<div class="result-item in-queue"
     hx-get="/api/job/{{ result.video_id }}/status-partial"
     hx-trigger="every 2s"
     hx-swap="outerHTML">
    {% if result.thumbnail %}
    <img class="result-thumb" src="{{ result.thumbnail }}" alt="" loading="lazy" onerror="this.style.display='none';this.nextElementSibling.style.display='flex';">
    <div class="result-thumb music-note-placeholder" style="display:none;"><span class="icon icon-music"></span></div>
    {% else %}
    <div class="result-thumb music-note-placeholder"><span class="icon icon-music"></span></div>
    {% endif %}
    
    <div class="result-info">
        <div class="result-title">{{ result.title }}</div>
        <div class="result-meta">{{ result.artist }}</div>
        <div class="result-badges">
            <span class="source-badge {{ result.source }}">{{ result.source|upper }}</span>
            {% if result.quality %}
            <span class="quality-badge {% if result.quality == 'HI_RES_LOSSLESS' %}hires{% elseif result.quality == 'LOSSLESS' %}flac{% endif %}">{{ result.quality == 'HI_RES_LOSSLESS' ? 'Hi-Res' : (result.quality == 'LOSSLESS' ? 'Lossless' : result.quality) }}</span>
            {% endif %}
            <span class="result-duration">{{ result.duration_string }}</span>
        </div>
    </div>
    <div class="status-icon queued" title="In Queue">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
    </div>
</div>
{% else %}
{# Not in library or queue - show download button #}
<form class="result-item" 
      hx-post="/download" 
      hx-swap="outerHTML" 
      hx-target="this"
      style="cursor: pointer;">
    <input type="hidden" name="video_id" value="{{ result.video_id }}">
    <input type="hidden" name="source" value="{{ result.source }}">
    <input type="hidden" name="title" value="{{ result.title|e('html_attr') }}">
    <input type="hidden" name="artist" value="{{ result.artist|e('html_attr') }}">
    <input type="hidden" name="url" value="{{ result.url }}">
    <input type="hidden" name="thumbnail" value="{{ result.thumbnail }}">
    <input type="hidden" name="convert_to_flac" value="1">
    
    {% if result.thumbnail %}
    <img class="result-thumb" src="{{ result.thumbnail }}" alt="" loading="lazy" onerror="this.style.display='none';this.nextElementSibling.style.display='flex';">
    <div class="result-thumb music-note-placeholder" style="display:none;"><span class="icon icon-music"></span></div>
    {% else %}
    <div class="result-thumb music-note-placeholder"><span class="icon icon-music"></span></div>
    {% endif %}
    
    <div class="result-info">
        <div class="result-title">{{ result.title }}</div>
        <div class="result-meta">{{ result.artist }}</div>
        <div class="result-badges">
            <span class="source-badge {{ result.source }}">{{ result.source|upper }}</span>
            {% if result.quality %}
            <span class="quality-badge {% if result.quality == 'HI_RES_LOSSLESS' %}hires{% elseif result.quality == 'LOSSLESS' %}flac{% endif %}">{{ result.quality == 'HI_RES_LOSSLESS' ? 'Hi-Res' : (result.quality == 'LOSSLESS' ? 'Lossless' : result.quality) }}</span>
            {% endif %}
            <span class="result-duration">{{ result.duration_string }}</span>
        </div>
    </div>
    <button type="submit" class="download-btn">
        <span class="btn-icon">‚¨á</span>
        <span class="btn-spinner"></span>
    </button>
</form>
{% endif %}
{% endfor %}
{% endif %}
